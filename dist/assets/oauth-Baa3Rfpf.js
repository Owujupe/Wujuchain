import{a8 as h}from"./index-fFHDa7eL.js";import{a as m}from"./types-DlKe2M91.js";const k="/sdk/2022-08-12/embedded-wallet",d=r=>`thirdwebEwsWalletUserId-${r}`,A="walletToken",u=r=>`${A}-${r}`,w=r=>`passkey-credential-id-${r}`,L="a",c=(r,e)=>`${L}-${r}-${e}`,I=r=>`walletConnectSessions-${r}`,g=r=>`thirdweb_guest_session_id_${r}`,p=new Map;class y{constructor({storage:e,clientId:t,ecosystem:n}){Object.defineProperty(this,"key",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"storage",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ecosystem",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.storage=e,this.key=S(t,n==null?void 0:n.id),this.ecosystem=n}async getItem(e){return this.storage?this.storage.getItem(e):p.get(e)??null}async setItem(e,t){if(this.storage)return this.storage.setItem(e,t);p.set(e,t)}async removeItem(e){const t=await this.getItem(e);return this.storage&&t?(this.storage.removeItem(e),!0):!1}async getWalletConnectSessions(){return this.getItem(I(this.key))}async saveWalletConnectSessions(e){await this.setItem(I(this.key),e)}async savePasskeyCredentialId(e){await this.setItem(w(this.key),e)}async getPasskeyCredentialId(){return this.getItem(w(this.key))}async saveAuthCookie(e){await this.setItem(u(this.key),e)}async getAuthCookie(){return this.getItem(u(this.key))}async removeAuthCookie(){return this.removeItem(u(this.key))}async saveDeviceShare(e,t){await this.saveWalletUserId(t),await this.setItem(c(this.key,t),e)}async getDeviceShare(){const e=await this.getWalletUserId();return e?this.getItem(c(this.key,e)):null}async removeDeviceShare(){const e=await this.getWalletUserId();return e?this.removeItem(c(this.key,e)):!1}async getWalletUserId(){return this.getItem(d(this.key))}async saveWalletUserId(e){await this.setItem(d(this.key),e)}async removeWalletUserId(){return this.removeItem(d(this.key))}async getGuestSessionId(){return this.getItem(g(this.key))}async saveGuestSessionId(e){await this.setItem(g(this.key),e)}}const S=(r,e)=>`${r}${e?`-${e}`:""}`,f=r=>{if(!m.includes(r))throw new Error(`Unknown auth option ${r}`);switch(r){case"wallet":return"siwe";default:return r}},_=({authOption:r,client:e,ecosystem:t,mode:n="popup",redirectUrl:a})=>{if(n==="popup"&&a)throw new Error("Redirect URL is not supported for popup mode");if(n==="window"&&!a)throw new Error("Redirect URL is required for window mode");const l=f(r);let i=`${h("inAppWallet")}/api/2024-05-05/login/${l}?clientId=${e.clientId}`;if(t!=null&&t.partnerId?i=`${i}&ecosystemId=${t.id}&ecosystemPartnerId=${t.partnerId}`:t&&(i=`${i}&ecosystemId=${t.id}`),n!=="popup"){const s=new URL(a||window.location.href);s.searchParams.set("walletId",(t==null?void 0:t.id)||"inApp"),s.searchParams.set("authProvider",r),i=`${i}&redirectUrl=${encodeURIComponent(s.toString())}`}return i},R=({authOption:r,client:e,ecosystem:t})=>{const n=f(r);let a=`${h("inAppWallet")}/api/2024-05-05/login/${n}/callback?clientId=${e.clientId}`;return t!=null&&t.partnerId?a=`${a}&ecosystemId=${t.id}&ecosystemPartnerId=${t.partnerId}`:t&&(a=`${a}&ecosystemId=${t.id}`),a},O="width=350, height=500",E=({isWindowOpenedByFn:r,win:e,closeOpenedWindow:t})=>{r?e==null||e.close():e&&t?t(e):e&&e.close()};async function C(r){const e=_({...r,mode:r.mode||"redirect"});r.mode==="redirect"?window.location.href=e:window.open(e),await new Promise(t=>setTimeout(t,5e3))}const T=async r=>{let e=r.openedWindow,t=!1;if(e||(e=window.open(_({...r,mode:"popup"}),`Login to ${r.authOption}`,O),t=!0),!e)throw new Error("Something went wrong opening pop-up");return await new Promise((a,l)=>{const i=window.setInterval(async()=>{e.closed&&(clearInterval(i),window.removeEventListener("message",s),l(new Error("User closed login window")))},1e3),s=async o=>{if(o.origin===h("inAppWallet")){if(typeof o.data!="object"){l(new Error("Invalid event data"));return}switch(o.data.eventType){case"oauthSuccessResult":{window.removeEventListener("message",s),clearInterval(i),E({isWindowOpenedByFn:t,win:e,closeOpenedWindow:r.closeOpenedWindow}),o.data.authResult&&a(o.data.authResult);break}case"oauthFailureResult":{window.removeEventListener("message",s),clearInterval(i),E({isWindowOpenedByFn:t,win:e,closeOpenedWindow:r.closeOpenedWindow}),l(new Error(o.data.errorString));break}}}};window.addEventListener("message",s)})};export{y as C,k as I,R as a,T as b,_ as g,C as l};
